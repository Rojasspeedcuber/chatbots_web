{
  "name": "Bible AI Chatbot - Web API",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chat/bible",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "webhook-trigger",
      "name": "Webhook - Chat Bible API",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "bible-chat-webhook",
      "notes": "Endpoint principal: POST /webhook/chat/bible\n\nEspera body JSON:\n{\n  \"message\": \"pergunta do usu√°rio\",\n  \"sessionId\": \"id-unico-sessao\",\n  \"userId\": \"id-usuario-opcional\"\n}"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// VALIDA√á√ÉO DE PAR√ÇMETROS DA REQUISI√á√ÉO\n// ========================================\n\nconst items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const body = item.json.body || item.json;\n  \n  // Validar campo obrigat√≥rio: message\n  if (!body.message || typeof body.message !== 'string' || body.message.trim() === '') {\n    throw new Error('VALIDATION_ERROR: Campo \"message\" √© obrigat√≥rio e deve ser uma string n√£o vazia.');\n  }\n  \n  // Gerar sessionId se n√£o fornecido\n  const sessionId = body.sessionId || `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  \n  // UserId opcional\n  const userId = body.userId || 'anonymous';\n  \n  // Limitar tamanho da mensagem (seguran√ßa)\n  const maxLength = 2000;\n  const userMessage = body.message.trim().substring(0, maxLength);\n  \n  results.push({\n    json: {\n      userMessage,\n      sessionId,\n      userId,\n      timestamp: new Date().toISOString(),\n      requestId: `req_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`\n    }\n  });\n}\n\nreturn results;"
      },
      "id": "validate-params",
      "name": "Validar Par√¢metros",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [470, 300],
      "notes": "Valida os par√¢metros recebidos:\n- message (obrigat√≥rio)\n- sessionId (gerado se n√£o fornecido)\n- userId (opcional, default: anonymous)\n\nLimita mensagem a 2000 caracteres por seguran√ßa."
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// CONSTRU√á√ÉO DO PROMPT COM CONTEXTO B√çBLICO\n// ========================================\n\nconst items = $input.all();\nconst results = [];\n\n// Prompt de sistema com contexto b√≠blico profundo\nconst BIBLE_SYSTEM_PROMPT = `Voc√™ √© um assistente espiritual crist√£o especializado na B√≠blia Sagrada. Seu papel √©:\n\n## IDENTIDADE E PROP√ìSITO\n- Voc√™ √© um conselheiro b√≠blico s√°bio, compassivo e acolhedor\n- Seu conhecimento abrange toda a B√≠blia (Antigo e Novo Testamento)\n- Voc√™ conhece profundamente teologia crist√£, hist√≥ria b√≠blica e interpreta√ß√£o das Escrituras\n\n## DIRETRIZES DE RESPOSTA\n1. **Base B√≠blica**: Sempre fundamente suas respostas nas Escrituras Sagradas\n2. **Cita√ß√µes**: Inclua vers√≠culos relevantes com refer√™ncia (ex: Jo√£o 3:16)\n3. **Contextualiza√ß√£o**: Explique o contexto hist√≥rico e cultural quando relevante\n4. **Aplica√ß√£o Pr√°tica**: Conecte os ensinamentos b√≠blicos com a vida cotidiana\n5. **Tom Acolhedor**: Seja gentil, emp√°tico e encorajador\n6. **Precis√£o**: Se n√£o souber algo com certeza, admita humildemente\n\n## LIMITA√á√ïES\n- N√£o fa√ßa previs√µes sobre o futuro ou profecias pessoais\n- N√£o substitua aconselhamento profissional (m√©dico, jur√≠dico, psicol√≥gico)\n- N√£o entre em debates denominacionais divisivos\n- Mantenha respeito por diferentes tradi√ß√µes crist√£s\n\n## FORMATO DE RESPOSTA\n- Seja conciso mas completo\n- Use linguagem clara e acess√≠vel\n- Organize respostas longas em t√≥picos quando apropriado\n- Sempre termine com uma palavra de encorajamento ou reflex√£o\n\nResponda em portugu√™s brasileiro de forma natural e acolhedora.`;\n\nfor (const item of items) {\n  const { userMessage, sessionId, userId, timestamp, requestId } = item.json;\n  \n  // Construir mensagens para a API\n  const messages = [\n    {\n      role: 'system',\n      content: BIBLE_SYSTEM_PROMPT\n    },\n    {\n      role: 'user',\n      content: userMessage\n    }\n  ];\n  \n  results.push({\n    json: {\n      messages,\n      userMessage,\n      sessionId,\n      userId,\n      timestamp,\n      requestId,\n      model: 'gpt-4o-mini', // Pode ser alterado para gpt-4, claude, etc.\n      maxTokens: 1500,\n      temperature: 0.7\n    }\n  });\n}\n\nreturn results;"
      },
      "id": "build-prompt",
      "name": "Construir Prompt B√≠blico",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [690, 300],
      "notes": "Monta o prompt com contexto b√≠blico profundo.\n\nO system prompt define:\n- Identidade do assistente\n- Diretrizes de resposta\n- Limita√ß√µes √©ticas\n- Formato de sa√≠da\n\nVari√°veis configur√°veis:\n- model: modelo de IA\n- maxTokens: limite de tokens\n- temperature: criatividade"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"model\": $json.model,\n  \"messages\": $json.messages,\n  \"max_tokens\": $json.maxTokens,\n  \"temperature\": $json.temperature,\n  \"presence_penalty\": 0.1,\n  \"frequency_penalty\": 0.1\n} }}",
        "options": {
          "timeout": 60000,
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "call-openai",
      "name": "Chamar OpenAI API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [910, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "CONFIGURE_CREDENTIAL_ID",
          "name": "OpenAI API Key"
        }
      },
      "notes": "Chamada para OpenAI Chat Completions API.\n\nCONFIGURA√á√ÉO NECESS√ÅRIA:\n1. Criar credencial HTTP Header Auth no n8n\n2. Header Name: Authorization\n3. Header Value: Bearer sk-YOUR-API-KEY\n\nPara usar Anthropic Claude:\n- URL: https://api.anthropic.com/v1/messages\n- Ajustar body conforme API Claude\n\nTimeout: 60 segundos"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// PROCESSAR RESPOSTA DA IA\n// ========================================\n\nconst items = $input.all();\nconst inputData = $('Construir Prompt B√≠blico').first().json;\nconst results = [];\n\nfor (const item of items) {\n  const response = item.json;\n  \n  // Verificar se a resposta √© v√°lida\n  if (!response.body || !response.body.choices || !response.body.choices[0]) {\n    throw new Error('AI_ERROR: Resposta inv√°lida da API de IA');\n  }\n  \n  const aiResponse = response.body.choices[0].message.content;\n  const usage = response.body.usage || {};\n  \n  results.push({\n    json: {\n      response: aiResponse,\n      status: 'success',\n      metadata: {\n        requestId: inputData.requestId,\n        sessionId: inputData.sessionId,\n        userId: inputData.userId,\n        timestamp: inputData.timestamp,\n        responseTimestamp: new Date().toISOString(),\n        model: response.body.model || inputData.model,\n        tokensUsed: {\n          prompt: usage.prompt_tokens || 0,\n          completion: usage.completion_tokens || 0,\n          total: usage.total_tokens || 0\n        }\n      }\n    }\n  });\n}\n\nreturn results;"
      },
      "id": "process-response",
      "name": "Processar Resposta IA",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1130, 300],
      "notes": "Extrai e formata a resposta da IA.\n\nRetorna objeto com:\n- response: texto da resposta\n- status: success/error\n- metadata: informa√ß√µes da requisi√ß√£o"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              },
              {
                "name": "X-Request-Id",
                "value": "={{ $json.metadata.requestId }}"
              }
            ]
          }
        }
      },
      "id": "respond-success",
      "name": "Responder Sucesso",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1350, 300],
      "notes": "Retorna resposta JSON de sucesso (HTTP 200).\n\nFormato:\n{\n  \"response\": \"texto da IA\",\n  \"status\": \"success\",\n  \"metadata\": {...}\n}"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// TRATAMENTO DE ERROS CENTRALIZADO\n// ========================================\n\nconst error = $input.first().json;\nconst errorMessage = error.message || error.error?.message || 'Erro desconhecido';\nconst errorStack = error.stack || '';\n\n// Classificar tipo de erro\nlet errorType = 'INTERNAL_ERROR';\nlet statusCode = 500;\nlet userMessage = 'Ocorreu um erro interno. Por favor, tente novamente.';\n\nif (errorMessage.includes('VALIDATION_ERROR')) {\n  errorType = 'VALIDATION_ERROR';\n  statusCode = 400;\n  userMessage = errorMessage.replace('VALIDATION_ERROR: ', '');\n} else if (errorMessage.includes('AI_ERROR')) {\n  errorType = 'AI_SERVICE_ERROR';\n  statusCode = 502;\n  userMessage = 'O servi√ßo de IA est√° temporariamente indispon√≠vel. Tente novamente em alguns instantes.';\n} else if (errorMessage.includes('timeout') || errorMessage.includes('ETIMEDOUT')) {\n  errorType = 'TIMEOUT_ERROR';\n  statusCode = 504;\n  userMessage = 'A requisi√ß√£o demorou muito para ser processada. Tente novamente.';\n} else if (errorMessage.includes('401') || errorMessage.includes('Unauthorized')) {\n  errorType = 'AUTH_ERROR';\n  statusCode = 500;\n  userMessage = 'Erro de configura√ß√£o do servi√ßo. Contate o administrador.';\n} else if (errorMessage.includes('429') || errorMessage.includes('rate limit')) {\n  errorType = 'RATE_LIMIT_ERROR';\n  statusCode = 429;\n  userMessage = 'Muitas requisi√ß√µes. Aguarde alguns segundos e tente novamente.';\n}\n\nreturn [{\n  json: {\n    response: null,\n    status: 'error',\n    error: {\n      type: errorType,\n      message: userMessage,\n      code: statusCode,\n      timestamp: new Date().toISOString(),\n      // Detalhes t√©cnicos (remover em produ√ß√£o se necess√°rio)\n      _debug: {\n        originalMessage: errorMessage,\n        stack: errorStack.substring(0, 500)\n      }\n    }\n  },\n  statusCode\n}];"
      },
      "id": "error-handler",
      "name": "Tratar Erros",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [910, 520],
      "notes": "Tratamento centralizado de erros.\n\nClassifica erros por tipo:\n- VALIDATION_ERROR (400)\n- AI_SERVICE_ERROR (502)\n- TIMEOUT_ERROR (504)\n- AUTH_ERROR (500)\n- RATE_LIMIT_ERROR (429)\n- INTERNAL_ERROR (500)\n\nRetorna mensagem amig√°vel ao usu√°rio."
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { response: $json.response, status: $json.status, error: $json.error } }}",
        "options": {
          "responseCode": "={{ $json.statusCode }}",
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "id": "respond-error",
      "name": "Responder Erro",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1130, 520],
      "notes": "Retorna resposta de erro com c√≥digo HTTP apropriado."
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// LOG DE INTERA√á√ïES (OPCIONAL)\n// ========================================\n\nconst inputData = $('Processar Resposta IA').first().json;\nconst promptData = $('Construir Prompt B√≠blico').first().json;\n\nconst logEntry = {\n  timestamp: new Date().toISOString(),\n  requestId: inputData.metadata.requestId,\n  sessionId: inputData.metadata.sessionId,\n  userId: inputData.metadata.userId,\n  userMessage: promptData.userMessage,\n  aiResponse: inputData.response.substring(0, 500) + (inputData.response.length > 500 ? '...' : ''),\n  tokensUsed: inputData.metadata.tokensUsed,\n  model: inputData.metadata.model,\n  status: 'success'\n};\n\nconsole.log('=== BIBLE CHAT LOG ===' );\nconsole.log(JSON.stringify(logEntry, null, 2));\n\nreturn [{ json: logEntry }];"
      },
      "id": "log-interaction",
      "name": "Log Intera√ß√£o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1350, 480],
      "notes": "Log opcional das intera√ß√µes.\n\nPara persistir em banco de dados:\n1. Adicione node PostgreSQL/MySQL/MongoDB ap√≥s este\n2. Configure tabela/collection para logs\n\nPara arquivo:\n1. Use node Write File\n2. Configure path do arquivo"
    },
    {
      "parameters": {},
      "id": "noop-end",
      "name": "Fim (Log)",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1560, 480],
      "notes": "N√≥ final ap√≥s logging."
    },
    {
      "parameters": {
        "content": "## üìñ Bible AI Chatbot - Web API\n\n### Endpoint\n`POST /webhook/chat/bible`\n\n### Body (JSON)\n```json\n{\n  \"message\": \"O que a B√≠blia diz sobre amor?\",\n  \"sessionId\": \"opcional-id-sessao\",\n  \"userId\": \"opcional-id-usuario\"\n}\n```\n\n### Resposta Sucesso (200)\n```json\n{\n  \"response\": \"Resposta da IA...\",\n  \"status\": \"success\",\n  \"metadata\": {\n    \"requestId\": \"req_xxx\",\n    \"sessionId\": \"session_xxx\",\n    \"tokensUsed\": {...}\n  }\n}\n```\n\n### Configura√ß√£o Necess√°ria\n1. **Credencial OpenAI**: HTTP Header Auth\n   - Name: `Authorization`\n   - Value: `Bearer sk-YOUR-KEY`\n\n2. **Vari√°veis de Ambiente (EasyPanel)**:\n   - `OPENAI_API_KEY`: Chave da API\n   - `N8N_WEBHOOK_URL`: URL base do n8n",
        "height": 580,
        "width": 340,
        "color": 4
      },
      "id": "sticky-docs",
      "name": "Documenta√ß√£o",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-60, 180]
    },
    {
      "parameters": {
        "content": "## ‚öôÔ∏è Fluxo de Execu√ß√£o\n\n1. **Webhook** recebe POST\n2. **Valida√ß√£o** dos par√¢metros\n3. **Prompt** constru√≠do com contexto b√≠blico\n4. **OpenAI** processa a pergunta\n5. **Resposta** formatada e retornada\n\n### Error Handling\n- Erros s√£o capturados em qualquer etapa\n- Respostas de erro padronizadas\n- C√≥digos HTTP apropriados",
        "height": 300,
        "width": 280,
        "color": 6
      },
      "id": "sticky-flow",
      "name": "Fluxo",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [250, 60]
    },
    {
      "parameters": {
        "content": "## üîß Para usar Anthropic Claude\n\nAltere o node \"Chamar OpenAI API\":\n\n**URL:** `https://api.anthropic.com/v1/messages`\n\n**Headers:**\n- `x-api-key`: sua-chave\n- `anthropic-version`: 2023-06-01\n\n**Body:**\n```json\n{\n  \"model\": \"claude-3-sonnet-20240229\",\n  \"max_tokens\": 1500,\n  \"messages\": [...]\n}\n```",
        "height": 300,
        "width": 280,
        "color": 3
      },
      "id": "sticky-anthropic",
      "name": "Alternativa Claude",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [560, 60]
    }
  ],
  "connections": {
    "Webhook - Chat Bible API": {
      "main": [
        [
          {
            "node": "Validar Par√¢metros",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Par√¢metros": {
      "main": [
        [
          {
            "node": "Construir Prompt B√≠blico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Construir Prompt B√≠blico": {
      "main": [
        [
          {
            "node": "Chamar OpenAI API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chamar OpenAI API": {
      "main": [
        [
          {
            "node": "Processar Resposta IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Resposta IA": {
      "main": [
        [
          {
            "node": "Responder Sucesso",
            "type": "main",
            "index": 0
          },
          {
            "node": "Log Intera√ß√£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tratar Erros": {
      "main": [
        [
          {
            "node": "Responder Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Intera√ß√£o": {
      "main": [
        [
          {
            "node": "Fim (Log)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "staticData": null,
  "tags": [
    {
      "name": "chatbot",
      "id": "1"
    },
    {
      "name": "bible",
      "id": "2"
    },
    {
      "name": "ai",
      "id": "3"
    },
    {
      "name": "web-api",
      "id": "4"
    }
  ],
  "triggerCount": 1,
  "meta": {
    "templateId": "bible-ai-chatbot-web",
    "templateCredsSetupCompleted": false,
    "instanceId": "easypanel-n8n"
  },
  "pinData": {}
}
