# ============================================
# DOCKER COMPOSE - Bible AI Chat
# Versao: 2024/2025 (Compose V2 - sem version key)
# ============================================
# NOTA: A chave 'version' foi removida pois esta deprecated
# no Docker Compose V2+. Use 'docker compose' (sem hifen).

services:
  # ============================================
  # FRONTEND - Nginx servindo arquivos estaticos
  # ============================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      # Para usar versao minificada (menor), use:
      # dockerfile: Dockerfile.frontend.minified
    image: bible-chat-frontend:latest
    container_name: bible-chat-frontend
    ports:
      - "${FRONTEND_PORT:-80}:80"
    depends_on:
      n8n:
        condition: service_healthy
    networks:
      - bible-chat-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # N8N - Backend de automacao
  # Versao: 1.73.1 (Janeiro 2025 - pinned)
  # ============================================
  n8n:
    image: docker.n8n.io/n8nio/n8n:1.73.1
    container_name: bible-chat-n8n
    ports:
      - "${N8N_PORT:-5678}:5678"
    environment:
      # Configuracoes basicas
      - N8N_HOST=${N8N_HOST:-0.0.0.0}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678}
      - N8N_EDITOR_BASE_URL=${N8N_EDITOR_BASE_URL:-http://localhost:5678}

      # Banco de dados PostgreSQL
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB:-n8n}
      - DB_POSTGRESDB_USER=${POSTGRES_USER:-n8n}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD:-n8n_secure_password_2025}
      - DB_POSTGRESDB_SCHEMA=public

      # Seguranca e autenticacao
      - N8N_BASIC_AUTH_ACTIVE=false
      - N8N_USER_MANAGEMENT_DISABLED=false
      - N8N_PERSONALIZATION_ENABLED=true

      # Execucao de workflows
      - EXECUTIONS_MODE=regular
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=336

      # Queue mode com Redis (opcional - descomente para escalar)
      # - EXECUTIONS_MODE=queue
      # - QUEUE_BULL_REDIS_HOST=redis
      # - QUEUE_BULL_REDIS_PORT=6379
      # - QUEUE_BULL_REDIS_PASSWORD=${REDIS_PASSWORD:-redis_secure_password_2025}

      # Timezone
      - GENERIC_TIMEZONE=${TIMEZONE:-America/Sao_Paulo}
      - TZ=${TIMEZONE:-America/Sao_Paulo}

      # Logs e debug
      - N8N_LOG_LEVEL=${N8N_LOG_LEVEL:-info}
      - N8N_LOG_OUTPUT=console

      # Metricas (opcional)
      - N8N_METRICS=true
      - N8N_METRICS_PREFIX=n8n_

      # Chaves de API externas
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - MP_ACCESS_TOKEN=${MP_ACCESS_TOKEN:-}

      # Seguranca adicional
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=true
    volumes:
      - n8n_data:/home/node/.n8n
      - ./n8n/workflows:/home/node/.n8n/workflows:ro
    user: "node"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - bible-chat-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================
  # POSTGRESQL - Banco de dados
  # Versao: 16.6 (LTS estavel - Janeiro 2025)
  # ============================================
  postgres:
    image: postgres:16.6-alpine3.21
    container_name: bible-chat-postgres
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-n8n}
      POSTGRES_USER: ${POSTGRES_USER:-n8n}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-n8n_secure_password_2025}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
      - ./postgres/02-biblia-schema.sql:/docker-entrypoint-initdb.d/02-biblia-schema.sql:ro
    networks:
      - bible-chat-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-n8n} -d ${POSTGRES_DB:-n8n}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    # Limites de recursos (ajuste conforme necessario)
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ============================================
  # REDIS - Cache e filas (opcional)
  # Versao: 7.4.2 (Janeiro 2025)
  # ============================================
  redis:
    image: redis:7.4.2-alpine3.21
    container_name: bible-chat-redis
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD:-redis_secure_password_2025}
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - bible-chat-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis_secure_password_2025}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

# ============================================
# VOLUMES - Persistencia de dados
# ============================================
volumes:
  n8n_data:
    name: bible-chat-n8n-data
  postgres_data:
    name: bible-chat-postgres-data
  redis_data:
    name: bible-chat-redis-data

# ============================================
# NETWORKS
# ============================================
networks:
  bible-chat-network:
    name: bible-chat-network
    driver: bridge
